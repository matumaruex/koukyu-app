# 公休表アプリ - シフト生成ルールまとめ（Ver 1.7 時点）

## プロジェクト情報
- **場所**: `C:\Users\ureim\.gemini\antigravity\scratch\koukyu-app`
- **GitHub**: `https://github.com/matumaruex/koukyu-app.git`
- **現在のバージョン**: Ver 1.8
- **主要ファイル**: `scheduler.js`（アルゴリズム）、`app.js`（UI）、`index.html`（画面）

---

## シフトの種類
- **A（早番）**: 7:00〜16:00
- **B（遅番）**: 9:30〜18:30
- **夜（夜勤）**: 17:00〜翌朝
- **明（夜勤明け）**: 夜勤翌日（朝〜9:00にカウント）
- **A残（通し勤務）**: 7:00〜18:30（早番＋遅番）
- **P（パート）**: スタッフごとに設定した時間
- **休（公休）**: 休み

## 人員配置ルール
- **朝（7:00）**: 最低4人（夜勤明け1人 + 早番/A残/パート）
- **昼（10:00）**: 最低4人
- **夕（17:45）**: 最低4人（夜勤入り1人 + 遅番/A残）
- **日曜の朝・昼のみ**: 月3回まで3人に減らしてOK
- **日曜の夕方**: 4人必須（緩和なし）
- **平日は絶対4人以上**（3人はNG）

## 夜勤ルール
- 毎日1人必ず夜勤に入る
- 夜勤の翌日は自動で「明け」になる
- 夜勤タイプ: 「いつでもOK」「平日のみ（金土日は不可）」「なし」の3種
- 夜勤回数が少ない人を優先的に割り当て

## A残（通し勤務）ルール
- **目標**: 1人あたり月5〜6回
- **絶対上限**: 1人あたり月6回まで（7回以上は絶対NG）
- **連日禁止**: A残が2日連続するのはNG（`hasAdjacentOvertime`関数でチェック）
- **使い方**: 朝と夕方の両方が足りない場合に1人で両方カバーする手段

## 連勤ルール
- **デフォルト連勤上限**: 5日
- **夜勤ありフルタイム**: 自動で2日に制限
- **スタッフ個別設定可能**: 0=自動、1〜6で指定
- **連勤+1許容**: スタッフごとにON/OFF可能（チェックボックス）
  - ONの場合、上限を月最大1回まで+1日超えて連勤可能
  - カウンターで管理（`assignShift`関数で使用マーク）
- **パート**: 前方＋後方の両方向で連勤チェック

## 公休ルール
- **目標**: スタッフごとに設定（デフォルト9日/月）
- **公休絶対保証**: 出勤目標（=月日数-公休目標-夜勤明け数）に達したスタッフは候補から除外
- **SafeFirst戦略**: フェーズ4では出勤枚が残っているスタッフのみ候補、候補ゼロの場合のみ緩和
- **公休回復（フェーズ5.7）**: 公休が目標未満のスタッフの出勤を削る（単純削除+スワップ）
- **⚙️ 現状**: 5回中3回で全員9日達成。残り2回で1名が8日になるケースが稀に発生

## パートルール
- **勤務形態**: 週の上限日数あり（デフォルト3日/週）
- **シフト**: P（個別時間設定）
- **maxConsecutive ≤ 2 のスタッフ**: 2勤1休の最適パターン配置（3オフセットを全て試して最適を選択）
- **maxConsecutive > 2 のスタッフ**: ランダム開始日＋貪欲配置
- **休み均等化（フェーズ3.5）**: パート全員の休日数を揃える。目標値を超えて休みが多い人に追加出勤

## A/Bバランスルール
- フェーズ4のステップ3（早番配置）: A回数が少ない人を優先
- フェーズ4のステップ4（遅番配置）: B回数が少ない人を優先
- フェーズ4のステップ5（昼不足時）: 各スタッフのA/B回数を見て少ない方を選択
- フェーズ5（追加出勤）: A/Bバランスを考慮してシフト選択
- **フェーズ5.8**: A/Bの差が2以上のスタッフのシフトを入れ替え（人数を崩さない範囲で）

## 生成フェーズの順序
1. **フェーズ1**: 希望休の反映
2. **フェーズ2**: 夜勤の配置（月全体を均等に分散）
3. **フェーズ3**: パートシフト配置（2勤1休パターン or 貪欲配置）
4. **フェーズ3.5**: パート休み均等化（山口対策）
5. **フェーズ4**: フルタイム日勤配置（A/B/A残の最適配置、人数確保最優先）
6. **フェーズ5**: 出勤目標未達のスタッフの追加出勤（公休保証付き）
7. **フェーズ5.5**: 全日4人保証の最終救済ステップ
8. **フェーズ5.7**: 公休回復（公休が目標未満のスタッフの出勤を削る）
9. **フェーズ5.8**: A/B均等化（最終調整）
10. **フェーズ6**: 時間帯別の人数チェック（最終確認・警告生成）
11. **フェーズ7**: 最終バリデーション

## スタッフデータ構造
```javascript
{
  id: "staff_xxx",
  name: "松井",
  type: "fulltime" | "part",
  canNightShift: true/false,
  nightShiftType: "all" | "weekday" | "none",
  canOvertime: true/false,
  monthlyDaysOff: 9,
  maxConsecutive: 0,  // 0=自動
  allowConsecutivePlus1: false,
  // パートのみ:
  startTime: "09:00",
  endTime: "17:00",
  maxDaysPerWeek: 3
}
```

## 次回の修正予定
- **公休の完全保証**: 残り2/5回で1名が8日になるケースの解消
